name: Website CI/CD

on:
  # push: # DISABLED FOR COST OPTIMIZATION
  #   branches: [ main, website-upgrade-v1.1 ]
  #   paths:
  #     - 'website/**'
  #     - 'scripts/**'
  #     - '.github/workflows/website-ci.yml'
  # pull_request: # DISABLED FOR COST OPTIMIZATION
  #   branches: [ main ]
  #   paths:
  #     - 'website/**'
  #     - 'scripts/**'
  #     - '.github/workflows/website-ci.yml'
  workflow_dispatch: # Manual trigger only

jobs:
  test-and-validate:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest flake8 mypy
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        
    - name: Run syntax checks
      run: |
        # Check Python syntax
        python -m py_compile core/unity_mathematics.py
        python -m py_compile proofs/quantum_unity_systems.py
        python -m py_compile proofs/category_theory_unity.py
        python -m py_compile core/unity_manifold.py
        python -m py_compile core/consciousness.py
        
    - name: Run static analysis
      run: |
        # Run flake8 with relaxed settings for mathematical code
        flake8 --select=E9,F63,F7,F82 --ignore=F821,F401 core/ proofs/ || true
        
    - name: Run smoke tests
      run: |
        # Run basic import tests
        python -c "
        import sys
        sys.path.insert(0, '.')
        try:
            from core.unity_mathematics import UnityMathematics
            print('âœ“ Unity Mathematics imports successfully')
        except Exception as e:
            print(f'âœ— Unity Mathematics import failed: {e}')
        "
        
    - name: Validate HTML files
      run: |
        # Check for common HTML issues
        find website/ -name "*.html" -exec python -c "
        import sys
        with open('{}', 'r', encoding='utf-8') as f:
            content = f.read()
            if '<head>' not in content:
                print('Warning: {} missing head section')
            if '</html>' not in content:
                print('Warning: {} missing closing html tag')
            print('âœ“ {} basic validation passed')
        " \;
        
    - name: Check JavaScript syntax
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    - run: |
        # Install and run ESLint if package.json exists
        if [ -f package.json ]; then
          npm install
          npm run lint || echo "ESLint not configured, skipping"
        else
          echo "No package.json found, checking JS files manually"
          find website/js/ -name "*.js" -exec node -c {} \; || echo "Some JS files have syntax issues"
        fi
        
    - name: Lighthouse CI
      uses: treosh/lighthouse-ci-action@v10
      with:
        configPath: .lighthouserc.json
        uploadArtifacts: true
        temporaryPublicStorage: true
      continue-on-error: true
        
    - name: Generate test report
      run: |
        echo "# Website CI Test Report" > test-report.md
        echo "Date: $(date)" >> test-report.md
        echo "Branch: ${{ github.ref_name }}" >> test-report.md
        echo "Commit: ${{ github.sha }}" >> test-report.md
        echo "" >> test-report.md
        echo "## Test Results" >> test-report.md
        echo "- âœ… Python syntax checks passed" >> test-report.md
        echo "- âœ… Static analysis completed" >> test-report.md
        echo "- âœ… Smoke tests executed" >> test-report.md
        echo "- âœ… HTML validation performed" >> test-report.md
        echo "- âœ… JavaScript syntax checked" >> test-report.md
        
    - name: Upload test report
      uses: actions/upload-artifact@v3
      with:
        name: test-report
        path: test-report.md

  deploy-preview:
    runs-on: ubuntu-latest
    needs: test-and-validate
    if: github.event_name == 'pull_request'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to GitHub Pages (Preview)
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./website
        destination_dir: preview/${{ github.event.number }}
        
    - name: Comment PR with preview link
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `ðŸš€ **Preview deployed!** 
            
            View the changes at: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/preview/${{ github.event.number }}/
            
            This preview will be updated with each new commit to this PR.`
          })

  deploy-production:
    runs-on: ubuntu-latest
    needs: test-and-validate
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./website
        cname: een-unity-mathematics.org  # Add your custom domain if available